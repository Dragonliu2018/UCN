# 第8章 I/O操作的实现

## 01 理论知识

### 0x01 中断响应的时点与异常处理的时点是否相同？

* 中断响应是在指令执行结束时查询有无中断请求，有则立即响应；
* 异常是发生在指令执行过程中，一旦发现则马上处理。

### 0x02 填空

1. 从用户I/O软件切换到系统I/O软件的唯一途径是**系统调用。**
2. 适合磁盘的I/O控制方式是**DMA方式**。
3. 磁盘工作过程：寻道，旋转，读写。

### 0x03 公式

1. 磁盘平均存取时间 = 平均寻道时间 + 平均旋转等待时间 + 数据传输时间
2. 磁盘响应时间 = 排队时延 +  控制器时间 + 平均寻道时间 + 平均旋转等待时间 + 数据传输时间 
3. 数据传送速度\(吞吐量、I/O带宽\)： 单位时间内传送的数据量。 
4. 对主机占用率： 在进行I/O操作过程中，处理器有多少时间花费在I/O操作上。

## 03 计算

### 0x01 磁盘平均存取时间

* **问**：假定一个磁盘的转速为7200RPM，磁盘的平均寻道时间为10ms，内部数据传输率为1MB/s，不考虑排队等待时间。那么读一个512字节扇区的平均时间大约为 \(   ms\)（小数点后保留2位有效数字）
* **答**：**平均存取时间 = 平均寻道时间 + 平均旋转等待时间 + 数据传输时间**
  * 平均寻道时间 = 10ms
  * 平均旋转等待时间 = 磁盘旋转一圈的时间 ÷ 2（因为不知道扇区具体在哪按半圈算）=（60秒）/（2 \* 7200转/分钟）= 4.167ms；
  * 数据传输时间 = 传输的字节数/磁盘传输速度= 512B / 1M/s = 512 / 10^6  s= 0.512ms\(**容量是2的幂次，速度和带宽是10的幂次**\)
  * T = 10ms + 4.167ms + 0.512ms = 14.68ms

### 0x02 磁盘平均响应时间

* **问1**：假设一个程序重复完成将磁盘上一个4KB的数据块读出，进行相应处理后，写回到磁盘的另外一个数据区。各数据块内信息在磁盘上连续存放，数据块随机位于磁盘的一个磁道上。磁盘转速为7200 RPM，最大寻道时间为12ms，磁盘最大内部数据传输率为40MBps，磁盘控制器的开销为2ms，没有其他程序使用磁盘和处理器，并且磁盘读写操作和磁盘数据的处理时间不重叠。若程序对磁盘数据的处理需要20000个时钟周期，处理器时钟频率为500MHz，则磁盘平均响应时间约为（ ms）\(小数点后保留2位有效数字\)
* **答1**：**磁盘响应时间 = 排队时延 +  控制器时间 + 平均寻道时间 + 平均旋转等待时间 + 数据传输时间** 
  * **平均寻道时间 = 最大寻道时间 / 2** = 6ms
  * 平均旋转等待时间 = 磁盘旋转一圈的时间÷2（因为不知道扇区具体在哪按半圈算）=（60秒）/（2 \* 7200转/分钟）= 4.167ms
  * 数据传输时间  = 传输的字节数 / 磁盘传输速度= 4KB / 40MBps = 0.102ms
  * 控制器 = 2ms
  * 磁盘响应时间 = 6ms + 4.167ms + 0.102ms + 2ms = 12.27ms
* **问2**：该程序完成一次数据块“读出—处理—写回”操作所需的时间为（ ms）（小数点后保留2位有效数字）
* **答2**：T = 读出时间 + 处理时间 + 写回时间
  * 读出时间 = 写回时间 = 12.27ms
  * 处理时间 = 20000 / 500MHz = 0.04ms
  * T = 12.27ms \* 2 + 0.04ms = 24.58ms

{% embed url="https://www.bilibili.com/video/BV1Cf4y117j1/" %}

### 0x03 主机占用率

#### 中断控制I/O方式

* **问**：假定一个字长为32位的CPU的主频为500MHz，即CPU每秒产生 $$500×10^6$$ 个时钟周期。硬盘使用中断控制I/O方式进行数据传送，其传输速率为4MB/s，每次中断传输一个16字节的数据，要求没有任何数据传输被错过。每次中断的开销（包括用于中断响应和中断处理的时间）是500个时钟周期。如果硬盘仅有5%的时间进行数据传送，那么，CPU用于硬盘数据传送的时间占整个CPU时间的百分比为多少？
* **法1**：
  * CPU每秒应该至少执行中断次数： $$4MB/16B=250×10^3$$ 
  * 每秒内用于硬盘数据传输的时钟周期数： $$250×10^3×500=125×10^6$$ 
  * 硬盘100%工作状态下，CPU占用率： $$125×10^6 /(500×10^6)=25 \%$$ 
  * 硬盘5%工作状态下，CPU占用率： $$25 \% ×5\%=1.25\%$$ 
* **法2**：
  * 硬盘准备一个数据\(16B\)的时间： $$16 \mathrm{B} / 4 \mathrm{MB}=4 \mu \mathrm{s}$$ 
  * CPU用于一个数据输入/输出的时间： $$500/500M=1 \mu \mathrm{s}$$ 
  * 假定硬盘一直在工作的话，则硬盘每隔 $$4 \mu \mathrm{s}$$ 申请一次中断，每次中断CPU花 $$1 \mu \mathrm{s}$$ 的时间进行硬盘数据传送，CPU用于硬盘数据传送的时间占整个CPU时间的1/4，即25%
  * 硬盘5%工作状态下，CPU占用率： $$25 \% ×5\%=1.25\%$$       

#### DMA方式

* **问**：假定CPU的主频为500MHz。硬盘采用DMA方式进行数据传送，其数据传输率为4MB/s，每次DMA传输的数据量为8KB，要求没有任何数据传输被错过。如果CPU在DMA初始化设置和启动硬盘操作等方面用了1000个时钟周期，并且在DMA传送完成后的中断处理需要500个时钟，则在硬盘100%处于工作状态的情况下，CPU用于硬盘I/O操作的时间占整个CPU时间的百分比大约是多少？
* **答**：
  * 从硬盘上读/写8KB的数据所需时间： $$8 \mathrm{KB} / 4 \mathrm{MB} / \mathrm{s}=2.048 \mathrm{ms} \approx 2 \mathrm{ms}$$ 
  * 如果硬盘一直处于工作状态的话，为了不错过任何数据，CPU必须每秒有 $$1 /\left(2 \times 10^{-3}\right)=0.5 \times 10^{3}$$ 次DMA传送
  * 一秒内CPU用于硬盘I/O操作的时钟周期数： $$0.5×10×(1000+500)=750×10^3$$ 
  * CPU占用率： $$750×10^3/(500×10^6)=1.5 ×10^{-3}=0.15\%$$ 

